<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>[NTFAM] Nitrotype Family</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; background: #f5f6fa; color: #222; margin: 0; padding: 0;}
        .container { max-width: 900px; margin: 2rem auto; background: #fff; border-radius: 8px; box-shadow: 0 0 8px #eee; padding: 2rem;}
        h1, h2, h3 { color: #0356a8; }
        .stats { display: flex; gap: 2rem; margin-bottom: 1.5rem; }
        .stat { background: #f0f4fc; border-radius: 6px; padding: 1rem 2rem; min-width: 120px; text-align: center;}
        .btn { padding: 0.5em 1em; color: #fff; background: #0356a8; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;}
        .btn:active { background: #023d7a;}
        .section { margin-bottom: 2rem;}
        .table { width: 100%; border-collapse: collapse; margin-top: 1rem;}
        .table th, .table td { padding: 0.6em 0.8em; border-bottom: 1px solid #e8e8e8;}
        .table th { background: #eaf2fb;}
        .badge { display: inline-block; background: #d4edda; color: #155724; padding: 0.2em 0.6em; border-radius: 4px; margin-left: 0.5em;}
        .activity-list { list-style: none; padding: 0;}
        .activity-list li { margin-bottom: 0.5em;}
        @media (max-width: 700px) {
            .container { padding: 0.5rem; }
            .stats { flex-direction: column; gap: 0.8rem;}
        }
    </style>
</head>
<body>
<div class="container">
    <h1>[NTFAM] Nitrotype Family</h1>
    <div class="stats">
        <div class="stat">
            <h3>Total Members</h3>
            <div>{{ stats.total_members }}</div>
        </div>
        <div class="stat">
            <h3>Active Members</h3>
            <div>{{ stats.active_members }}</div>
        </div>
        <div class="stat">
            <h3>Total Races</h3>
            <div>{{ stats.total_races }}</div>
        </div>
        <div class="stat">
            <h3>Last Update</h3>
            <div id="last-update">
                {% if bot_status == 'running' %}
                    <span class="badge" style="background:#fff3cd;color:#856404;">In progress...</span>
                {% elif last_check_time %}
                    <span>{{ last_check_time.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                {% else %}
                    <span>No update yet</span>
                {% endif %}
            </div>
            <button class="btn" id="refresh-btn" onclick="runCheck()">Refresh</button>
            <div id="refresh-status"></div>
        </div>
    </div>

    <div class="section">
        <h2>Team Members</h2>
        {% if members|length == 0 %}
            <div>No team members found<br>
                <small>Team data will appear here after the first scan.</small>
            </div>
        {% else %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Display Name</th>
                        <th>Username</th>
                        <th>Races (24h)</th>
                        <th>Races (Week)</th>
                        <th>Total Races</th>
                        <th>NTC Owed</th>
                        <th>Progress</th>
                        <th>Status</th>
                        <th>Joined/Left</th>
                    </tr>
                </thead>
                <tbody>
                {% for member in members %}
                    <tr>
                        <td>{{ member.display_name }}</td>
                        <td>
                            <a href="{{ member.profile_url }}" target="_blank">{{ member.username }}</a>
                            {% if member.is_new %}
                                <span class="badge">New</span>
                            {% endif %}
                            {% if member.recently_left %}
                                <span class="badge" style="background:#f8d7da;color:#721c24;">Left</span>
                            {% endif %}
                        </td>
                        <td>{{ member.last_24_hours }}</td>
                        <td>{{ member.this_week }}</td>
                        <td>{{ member.total_team_races }}</td>
                        <td>{{ member.ntc_owed }}</td>
                        <td>{{ member.payment_progress }}</td>
                        <td>{{ member.status }}</td>
                        <td>{{ member.date_joined_left }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    <div class="section">
        <h2>Recent Activity</h2>
        {% if recent_activity|length == 0 %}
            <div>No recent activity logged.</div>
        {% else %}
            <ul class="activity-list">
            {% for act in recent_activity %}
                <li>
                    <b>{{ act.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</b>:
                    <span>{{ act.action }}</span>
                    {% if act.member_username %} - <span>{{ act.member_username }}</span>{% endif %}
                    {% if act.details %} - <span>{{ act.details }}</span>{% endif %}
                </li>
            {% endfor %}
            </ul>
        {% endif %}
    </div>
</div>

<script>
function runCheck() {
    var btn = document.getElementById('refresh-btn');
    var status = document.getElementById('refresh-status');
    btn.disabled = true;
    status.innerText = 'In progress...';
    fetch('/api/run-check', {method
