<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>[NTFAM] Nitrotype Family Team Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body { font-family: Arial, sans-serif; background: #fafafa; margin: 0; }
        .container { max-width: 1100px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);}
        h1, h2, h3 { margin-top: 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 12px; border-bottom: 1px solid #eee;}
        th { background: #f5f5f5; }
        .status-active { color: green; }
        .status-left { color: red; }
        .status-new { color: blue; }
        .btn { padding: 6px 14px; border: none; border-radius: 4px; background: #0073e6; color: white; cursor: pointer; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #refresh-status { margin-left: 10px; font-weight: bold; }
        .no-data { color: #888; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>[NTFAM] Nitrotype Family</h1>
        <div style="margin-bottom: 16px;">
            <span><strong>Total Members:</strong> {{ stats.total_members }}</span> &nbsp;|&nbsp;
            <span><strong>Active Members:</strong> {{ stats.active_members }}</span> &nbsp;|&nbsp;
            <span><strong>Total Races:</strong> {{ stats.total_races }}</span>
        </div>
        <div style="margin-bottom:20px;">
            <h3>Last Update</h3>
            <span id="last-update">
                {% if bot_status == 'running' %}
                    In progress...
                {% elif last_check_time %}
                    {{ last_check_time.strftime('%Y-%m-%d %H:%M:%S') }}
                {% else %}
                    No update yet
                {% endif %}
            </span>
            <button id="refresh-btn" class="btn" onclick="runCheck()">Refresh</button>
            <span id="refresh-status"></span>
        </div>
        <h2>Team Members</h2>
        <table>
            <thead>
                <tr>
                    <th>Display Name</th>
                    <th>Username</th>
                    <th>Last 24 Hours</th>
                    <th>This Week</th>
                    <th>Total Team Races</th>
                    <th>NTC Owed</th>
                    <th>Payment Progress</th>
                    <th>Min Requirements</th>
                    <th>Date Joined/Left</th>
                    <th>Status</th>
                    <th>Profile</th>
                </tr>
            </thead>
            <tbody>
                {% if members|length == 0 %}
                <tr><td colspan="11" class="no-data">No team members found<br>Team data will appear here after the first scan.</td></tr>
                {% else %}
                    {% for member in members %}
                    <tr>
                        <td>{{ member.display_name }}</td>
                        <td>{{ member.username }}</td>
                        <td>{{ member.last_24_hours }}</td>
                        <td>{{ member.this_week }}</td>
                        <td>{{ member.total_team_races }}</td>
                        <td>{{ member.ntc_owed }}</td>
                        <td>{{ member.payment_progress }}</td>
                        <td>{{ member.min_requirements_status }}</td>
                        <td>{{ member.date_joined_left }}</td>
                        <td>
                            {% if member.status == 'active' %}<span class="status-active">Active</span>
                            {% elif member.status == 'left' %}<span class="status-left">Left</span>
                            {% elif member.status == 'new' %}<span class="status-new">New</span>
                            {% else %}{{ member.status }}{% endif %}
                        </td>
                        <td><a href="{{ member.profile_url }}" target="_blank">More</a></td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
        <h2>Recent Activity</h2>
        <table>
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Action</th>
                    <th>Username</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% if recent_activity|length == 0 %}
                <tr><td colspan="4" class="no-data">No recent activity</td></tr>
                {% else %}
                {% for log in recent_activity %}
                <tr>
                    <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ log.action }}</td>
                    <td>{{ log.member_username }}</td>
                    <td>{{ log.details }}</td>
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
    <script>
    function runCheck() {
        document.getElementById('refresh-status').innerText = 'In progress...';
        fetch('/api/run-check', {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    document.getElementById('refresh-status').innerText = 'Update requested! Please refresh this page in a moment.';
                } else {
                    document.getElementById('refresh-status').innerText = 'Error: ' + (data.error || 'Unknown error');
                }
            }).catch(err => {
                document.getElementById('refresh-status').innerText = 'Error: ' + err;
            });
    }
    </script>
</body>
</html>
